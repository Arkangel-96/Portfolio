<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego Metroidvania Ninja</title>
<style>
body { margin:0; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; }
canvas { background:#222; border:2px solid #555; }
</style>
</head>
<body>
<canvas id="game" width="800" height="400"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

let platforms=[], camX=0, score=0, highscore=0;
let keys={}, gameRunning=true, restartBtnRect=null;

function makePlatform(x,y,w){ return {x,y,w,h:20,color:'#6cf'}; }

function resetPlatforms(){
  platforms=[
    makePlatform(0,H-20,3000),  // base
    makePlatform(350,H-180,300),
    makePlatform(650,H-300,300),
    makePlatform(950,H-300,300),
    makePlatform(1250,H-120,300),
    makePlatform(2000,H-130,300)
  ];
}

// --- PLAYER CON HITBOX VERDE ---
class Player {
  constructor(x,y){
    this.x = x;
    this.y = y;
    this.w = 50;
    this.h = 80;
    this.vx = 0;
    this.vy = 0;
    this.onGround = false;

    this.spriteW = 50;
    this.spriteH = 80;
    this.state = 'idle';
    this.frame = 0;
    this.frameSpeed = 0.2;
    this.animations = { idle: [], run: [], jump: [], attack: [], jump_attack: [], jump_throw: [], throw: [], dead: [] };
    this.loaded = false;
  }

  async loadImages(){
    const anims = Object.keys(this.animations);
    const promises = [];
    for(let anim of anims){
      for(let i=0;i<10;i++){
        const img = new Image();
        img.src = `ninja/${anim}/frame_${i}.png`;
        promises.push(new Promise(res=>{
          img.onload = () => res();
          img.onerror = () => res(); // si falla, igual continua
        }));
        this.animations[anim].push(img);
      }
    }
    await Promise.all(promises);
    this.loaded = true;
  }

  update(){
    // Movimiento horizontal
    this.vx = 0;
    if(keys['ArrowLeft']) this.vx = -4;
    if(keys['ArrowRight']) this.vx = 4;
    this.x += this.vx;

    // Gravedad
    this.vy += 0.25;
    this.y += this.vy;
    this.onGround = false;

    // Colisión vertical
    for(let p of platforms){
      if(this.x + this.w > p.x && this.x < p.x + p.w &&
         this.y + this.h > p.y && this.y + this.h < p.y + 20 &&
         this.vy >= 0){
        this.y = p.y - this.h;
        this.vy = 0;
        this.onGround = true;
      }
    }

    // Salto
    if(keys['ArrowUp'] && this.onGround) { this.vy = -10; this.onGround=false; }

    // Animación
    if(!gameRunning) this.state='dead';
    else if(!this.onGround){
      if(keys[' ']) this.state='jump_attack';
      else if(keys['t']) this.state='jump_throw';
      else this.state='jump';
    }
    else if(keys['ArrowRight'] || keys['ArrowLeft']) this.state='run';
    else if(keys['t']) this.state='throw';
    else this.state='idle';

    this.frame += this.frameSpeed;
    if(this.frame >= 10) this.frame = 0;
  }

  draw(ctx, camX){
    // HITBOX VERDE TRANSPARENTE
    ctx.strokeStyle = 'lime';
    ctx.lineWidth = 2;
    ctx.strokeRect(this.x - camX, this.y, this.w, this.h);

    // SPRITE COSMÉTICO
    if(this.loaded){
      const frameIndex = Math.floor(this.frame);
      const img = this.animations[this.state][frameIndex];
      ctx.drawImage(img, this.x - camX, this.y, this.spriteW, this.spriteH);
    }
  }
}

let player;

async function init(){
  resetPlatforms();
  player = new Player(100,H-100);
  camX = 0; score = 0; gameRunning = true;
  player.loaded = false;
  player.loadImages(); // carga asíncrona
}

init();

document.addEventListener('keydown', e => { keys[e.key]=true; if(e.key==='º') init(); });
document.addEventListener('keyup', e => keys[e.key]=false);

canvas.addEventListener('mousedown', e=>{
  if(!gameRunning && restartBtnRect){
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const {x,y,w,h} = restartBtnRect;
    if(mx>=x && mx<=x+w && my>=y && my<=y+h) init();
  }
});

function update(){
  if(!gameRunning) return;

  player.update();

  // Colisión lateral
  for(let p of platforms){
    if(player.x + player.w > p.x && player.x < p.x + p.w &&
       player.y + player.h > p.y && player.y < p.y + p.h){
      if(player.vx>0) player.x = p.x - player.w;
      else if(player.vx<0) player.x = p.x + p.w;
    }
  }

  // Cámara
  camX = player.x - W/2;
  if(camX<0) camX=0;

  // Puntaje
  score = Math.max(score, Math.floor(player.x/10));
  highscore = Math.max(highscore, score);

  // Game over
  if(player.y>H) gameRunning=false;
}

function draw(){
  ctx.clearRect(0,0,W,H);
  const g = ctx.createLinearGradient(0,0,W,0);
  g.addColorStop(0,'#07101a');
  g.addColorStop(1,'#041019');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  ctx.save();
  ctx.translate(-camX,0);
  for(let p of platforms) ctx.fillStyle=p.color, ctx.fillRect(p.x,p.y,p.w,p.h);
  player.draw(ctx, camX);
  ctx.restore();

  // HUD
  ctx.fillStyle='#fff';
  ctx.font='18px system-ui';
  ctx.textAlign='left';
  ctx.fillText('Puntaje: '+score,20,30);
  ctx.fillText('Mejor: '+highscore,20,55);
  ctx.font='14px system-ui';
  ctx.textAlign='center';
  ctx.fillText('←/→ mover · ↑ saltar · espacio atacar · t throw · º reinicia', W/2,30);

  // Botón reinicio
  if(!gameRunning){
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.fillRect(W/2-100,H/2-40,200,80);
    ctx.fillStyle='#fff';
    ctx.textAlign='center';
    ctx.font='bold 24px system-ui';
    ctx.fillText('YOU DIED',W/2,H/2+8);
    restartBtnRect={x:W/2-100,y:H/2-40,w:200,h:80};
  } else restartBtnRect=null;
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
